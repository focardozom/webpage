---
title: "Intro to causal inference"
date: "2023-09-29"
author: 
  - Francisco Cardozo
output:
  html:
    toc: true
    theme: pulse
    code-fold: true
    fontsize: 0.9em
editor_options: 
  chunk_output_type: console
---

<link href="/rmarkdown-libs/table1/table1_defaults.css" rel="stylesheet" />


<div id="observational-studies-and-propensity-score" class="section level1">
<h1>1. Observational studies and propensity score ⚖️</h1>
<ul>
<li>Conceptual stage</li>
<li>Design stage</li>
<li>Statistical analysis</li>
<li>Summary</li>
</ul>
<div id="conceptual" class="section level2">
<h2>Conceptual</h2>
<p>Formulation of the causal question and assumptions using potential
outcomes. Formulated as a randomized experiment.</p>
</div>
<div id="design-stage" class="section level2">
<h2>Design stage</h2>
<p>Reconstruct or approximate the design of a randomized experiment
(independence between treatment assignment and covariates). Needs to
conduct balance diagnostic.</p>
</div>
<div id="statistical-analysis" class="section level2">
<h2>Statistical analysis</h2>
<p>Compare outcomes by treatment. This stage is similar to the standard
model-based analysis.</p>
</div>
<div id="summary" class="section level2">
<h2>Summary</h2>
<p>Conclusion based on your estimates.</p>
</div>
</div>
<div id="example" class="section level1">
<h1>Example</h1>
<pre class="r"><code>library(tidyverse) # data manipulation
library(skimr) # Good for descriptive analysis 
library(tidymodels) # modeling
library(gt)  # To create pretty tables
library(table1) # To create pretty tables
tidymodels_prefer() # to avoid problems with two functions with the same name</code></pre>
<div id="conceptual-stage" class="section level2">
<h2>1. Conceptual stage</h2>
<blockquote>
<p>What is the effect of alcohol consumption on marihuana use?</p>
</blockquote>
<div id="dataset" class="section level3">
<h3>Dataset</h3>
<p>Selected data from YRBS</p>
<pre class="r"><code>#load(&quot;Causal_inference/small_data.rda&quot;)
load(&quot;small_data.rda&quot;)

small_data  |&gt; skimr::skim()</code></pre>
<table>
<caption><span id="tab:load-data">Table 1: </span>Data summary</caption>
<tbody>
<tr class="odd">
<td align="left">Name</td>
<td align="left">small_data</td>
</tr>
<tr class="even">
<td align="left">Number of rows</td>
<td align="left">31367</td>
</tr>
<tr class="odd">
<td align="left">Number of columns</td>
<td align="left">16</td>
</tr>
<tr class="even">
<td align="left">_______________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Column type frequency:</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">character</td>
<td align="left">2</td>
</tr>
<tr class="odd">
<td align="left">factor</td>
<td align="left">2</td>
</tr>
<tr class="even">
<td align="left">numeric</td>
<td align="left">12</td>
</tr>
<tr class="odd">
<td align="left">________________________</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">Group variables</td>
<td align="left">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table>
<colgroup>
<col width="19%" />
<col width="13%" />
<col width="19%" />
<col width="5%" />
<col width="5%" />
<col width="8%" />
<col width="12%" />
<col width="15%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">min</th>
<th align="right">max</th>
<th align="right">empty</th>
<th align="right">n_unique</th>
<th align="right">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">district</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">5</td>
<td align="right">12</td>
<td align="right">0</td>
<td align="right">13</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">state</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="right">0</td>
<td align="right">8</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table>
<colgroup>
<col width="18%" />
<col width="12%" />
<col width="18%" />
<col width="10%" />
<col width="11%" />
<col width="28%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="left">ordered</th>
<th align="right">n_unique</th>
<th align="left">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">alcohol</td>
<td align="right">1718</td>
<td align="right">0.95</td>
<td align="left">FALSE</td>
<td align="right">2</td>
<td align="left">Yes: 15746, No: 13903</td>
</tr>
<tr class="even">
<td align="left">marijuana</td>
<td align="right">700</td>
<td align="right">0.98</td>
<td align="left">FALSE</td>
<td align="right">2</td>
<td align="left">No: 19351, Yes: 11316</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table style="width:100%;">
<colgroup>
<col width="17%" />
<col width="12%" />
<col width="17%" />
<col width="9%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="7%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">mean</th>
<th align="right">sd</th>
<th align="right">p0</th>
<th align="right">p25</th>
<th align="right">p50</th>
<th align="right">p75</th>
<th align="right">p100</th>
<th align="left">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">year</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">2018.04</td>
<td align="right">1.00</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">2019</td>
<td align="right">2019</td>
<td align="right">2019</td>
<td align="left">▇▁▁▁▇</td>
</tr>
<tr class="even">
<td align="left">age</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">5.00</td>
<td align="right">1.23</td>
<td align="right">1</td>
<td align="right">4</td>
<td align="right">5</td>
<td align="right">6</td>
<td align="right">7</td>
<td align="left">▁▂▆▆▇</td>
</tr>
<tr class="odd">
<td align="left">sex</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.54</td>
<td align="right">0.50</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">▇▁▁▁▇</td>
</tr>
<tr class="even">
<td align="left">q30</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.82</td>
<td align="right">0.39</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">▂▁▁▁▇</td>
</tr>
<tr class="odd">
<td align="left">q50</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.03</td>
<td align="right">0.18</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td align="left">q51</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.06</td>
<td align="right">0.23</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td align="left">q52</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.01</td>
<td align="right">0.12</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td align="left">q53</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.02</td>
<td align="right">0.13</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td align="left">q54</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.03</td>
<td align="right">0.16</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td align="left">q55</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.02</td>
<td align="right">0.14</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td align="left">q56</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.02</td>
<td align="right">0.13</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td align="left">q57</td>
<td align="right">227</td>
<td align="right">0.99</td>
<td align="right">0.73</td>
<td align="right">0.45</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">▃▁▁▁▇</td>
</tr>
</tbody>
</table>
</div>
<div id="demographic-variables" class="section level3">
<h3>Demographic variables</h3>
<ul>
<li>Age</li>
<li>Sex</li>
</ul>
</div>
<div id="outcome" class="section level3">
<h3>Outcome</h3>
<ul>
<li><p>Q46. How old were you when you tried marijuana for the first
time? A. I have never tried marijuana B. 8 years old or younger C. 9
or 10 years old D. 11 or 12 years old E. 13 or 14 years old F. 15 or
16 years old G. 17 years old or older</p></li>
<li><p>marijuana: recoded as 0 (never used) 1 (used)</p></li>
</ul>
</div>
<div id="alcohol-use-treatment" class="section level3">
<h3>Alcohol use (“Treatment”)</h3>
<ul>
<li><p>Q40. How old were you when you had your first drink of alcohol other
than a few sips? A. I have never had a drink of alcohol other than a
few sips B. 8 years old or younger C. 9 or 10 years old D. 11 or 12
years old E. 13 or 14 years old F. 15 or 16 years old G. 17 years
old or older</p></li>
<li><p>alcohol: recoded as 0 (never used) 1 (used)</p></li>
</ul>
</div>
<div id="questions-about-drug-use" class="section level3">
<h3>Questions about drug use</h3>
<ul>
<li>Q30. Have you ever tried cigarette smoking, even one or two puffs?</li>
<li>Q50. During your life, how many times have you used any form of
cocaine, including powder, crack, or freebase?</li>
<li>Q51. During your life, how many times have you sniffed glue,
breathed the contents of aerosol spray cans, or inhaled any paints
or sprays to get high?</li>
<li>Q52. During your life, how many times have you used heroin (also
called smack, junk, or China White)?</li>
<li>Q53. During your life, how many times have you used methamphetamines
(also called speed, crystal meth, crank, ice, or meth)?</li>
<li>Q54. During your life, how many times have you used ecstasy (also
called MDMA)?</li>
<li>Q55. During your life, how many times have you taken steroid pills
or shots without a doctor’s prescription?</li>
<li>Q56. During your life, how many times have you used a needle to
inject any illegal drug into your body?</li>
<li>Q57. During the past 12 months, has anyone offered, sold, or given
you an illegal drug on school property?</li>
</ul>
</div>
<div id="filter-by-year" class="section level3">
<h3>Filter by year</h3>
<pre class="r"><code>data_2019 &lt;- small_data %&gt;% 
  filter(year==2019) %&gt;% 
  select(-district, -state)</code></pre>
</div>
</div>
<div id="design-stage-a" class="section level2">
<h2>2. Design stage (A)</h2>
<div id="balance-diagnostic" class="section level3">
<h3>Balance diagnostic</h3>
<pre class="r"><code>data_2019 %&gt;% 
  ggplot(aes(age, 
             fill=alcohol)) +
  geom_density(size=1, adjust=5, alpha=0.2) +
  theme_minimal()</code></pre>
<p><img src="/posts/2023-05-16-intro-to-causal/ipsw_files/figure-html/balance-age-1.png" width="672" /></p>
<pre class="r"><code>data_2019 %&gt;% 
  filter(!is.na(alcohol)) %&gt;% 
  mutate(sex=if_else(sex==1,1,0)) %&gt;% 
  group_by(alcohol) %&gt;% 
  summarise(`Females proportion`=
              mean(as.numeric(as.character(sex)), na.rm=T)) %&gt;% 
  ggplot(aes(alcohol, `Females proportion`, fill=alcohol)) +
  geom_bar(stat=&quot;identity&quot;) +
  theme_minimal() +
  theme(legend.position = &quot;none&quot;) +
  scale_fill_manual(values = c(&quot;purple&quot;, &quot;gold&quot;))</code></pre>
<p><img src="/posts/2023-05-16-intro-to-causal/ipsw_files/figure-html/balance-sex-1.png" width="672" /></p>
<pre class="r"><code>data_2019 %&gt;% 
  select(c(&quot;alcohol&quot;,  &quot;q30&quot;, &quot;q50&quot;, &quot;q51&quot;,&quot;q52&quot;,
           &quot;q53&quot;, &quot;q54&quot;, &quot;q55&quot;, &quot;q56&quot;)) %&gt;% 
  filter(!is.na(alcohol)) %&gt;% 
  pivot_longer(cols=-alcohol, 
               names_to = &quot;Drugs&quot;, 
               values_to=&quot;Use&quot; ) %&gt;% 
  group_by(alcohol, Drugs) %&gt;% 
  summarise(prevalence=mean(Use, na.rm=T)) %&gt;% 
  ggplot(aes(alcohol, prevalence)) +
  geom_bar(stat=&quot;identity&quot;) + 
  facet_wrap(~ Drugs, scales = &quot;free&quot;) +
  theme_minimal()</code></pre>
<p><img src="/posts/2023-05-16-intro-to-causal/ipsw_files/figure-html/balance-drug-1.png" width="672" /></p>
<pre class="r"><code>data_2019 %&gt;% 
  filter(!is.na(alcohol)) %&gt;% 
  select(c(&quot;alcohol&quot;,  &quot;q30&quot;, &quot;q50&quot;, &quot;q51&quot;,&quot;q52&quot;,
           &quot;q53&quot;, &quot;q54&quot;, &quot;q55&quot;, &quot;q56&quot;)) %&gt;% 
  mutate(id=row_number()) %&gt;% 
  pivot_longer(cols=-c(alcohol,id), 
               names_to = &quot;Drugs&quot;, 
               values_to=&quot;Use&quot; ) %&gt;% 
  group_by(id, alcohol) %&gt;% 
  summarise(sum=sum(as.numeric(Use), na.rm = T)) %&gt;% 
  ungroup() %&gt;% 
  count(alcohol, sum) %&gt;% 
  pivot_wider(names_from = sum, values_from = n) %&gt;% 
  gt() %&gt;% 
  tab_header(
    title = &quot;Number of substances&quot;)</code></pre>
<div id="jhnzqxyenv" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#jhnzqxyenv table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#jhnzqxyenv thead, #jhnzqxyenv tbody, #jhnzqxyenv tfoot, #jhnzqxyenv tr, #jhnzqxyenv td, #jhnzqxyenv th {
  border-style: none;
}

#jhnzqxyenv p {
  margin: 0;
  padding: 0;
}

#jhnzqxyenv .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#jhnzqxyenv .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#jhnzqxyenv .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#jhnzqxyenv .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#jhnzqxyenv .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#jhnzqxyenv .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jhnzqxyenv .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#jhnzqxyenv .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#jhnzqxyenv .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#jhnzqxyenv .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#jhnzqxyenv .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#jhnzqxyenv .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#jhnzqxyenv .gt_spanner_row {
  border-bottom-style: hidden;
}

#jhnzqxyenv .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#jhnzqxyenv .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#jhnzqxyenv .gt_from_md > :first-child {
  margin-top: 0;
}

#jhnzqxyenv .gt_from_md > :last-child {
  margin-bottom: 0;
}

#jhnzqxyenv .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#jhnzqxyenv .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#jhnzqxyenv .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#jhnzqxyenv .gt_row_group_first td {
  border-top-width: 2px;
}

#jhnzqxyenv .gt_row_group_first th {
  border-top-width: 2px;
}

#jhnzqxyenv .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#jhnzqxyenv .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#jhnzqxyenv .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#jhnzqxyenv .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jhnzqxyenv .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#jhnzqxyenv .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#jhnzqxyenv .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#jhnzqxyenv .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#jhnzqxyenv .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jhnzqxyenv .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#jhnzqxyenv .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#jhnzqxyenv .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#jhnzqxyenv .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#jhnzqxyenv .gt_left {
  text-align: left;
}

#jhnzqxyenv .gt_center {
  text-align: center;
}

#jhnzqxyenv .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#jhnzqxyenv .gt_font_normal {
  font-weight: normal;
}

#jhnzqxyenv .gt_font_bold {
  font-weight: bold;
}

#jhnzqxyenv .gt_font_italic {
  font-style: italic;
}

#jhnzqxyenv .gt_super {
  font-size: 65%;
}

#jhnzqxyenv .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#jhnzqxyenv .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#jhnzqxyenv .gt_indent_1 {
  text-indent: 5px;
}

#jhnzqxyenv .gt_indent_2 {
  text-indent: 10px;
}

#jhnzqxyenv .gt_indent_3 {
  text-indent: 15px;
}

#jhnzqxyenv .gt_indent_4 {
  text-indent: 20px;
}

#jhnzqxyenv .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    <tr class="gt_heading">
      <td colspan="10" class="gt_heading gt_title gt_font_normal gt_bottom_border" style>Number of substances</td>
    </tr>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="alcohol">alcohol</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="0">0</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="1">1</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="2">2</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="3">3</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="4">4</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="5">5</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="7">7</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="6">6</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="8">8</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="alcohol" class="gt_row gt_center">No</td>
<td headers="0" class="gt_row gt_right">285</td>
<td headers="1" class="gt_row gt_right">6980</td>
<td headers="2" class="gt_row gt_right">211</td>
<td headers="3" class="gt_row gt_right">21</td>
<td headers="4" class="gt_row gt_right">5</td>
<td headers="5" class="gt_row gt_right">5</td>
<td headers="7" class="gt_row gt_right">1</td>
<td headers="6" class="gt_row gt_right">NA</td>
<td headers="8" class="gt_row gt_right">NA</td></tr>
    <tr><td headers="alcohol" class="gt_row gt_center">Yes</td>
<td headers="0" class="gt_row gt_right">1585</td>
<td headers="1" class="gt_row gt_right">5782</td>
<td headers="2" class="gt_row gt_right">603</td>
<td headers="3" class="gt_row gt_right">106</td>
<td headers="4" class="gt_row gt_right">45</td>
<td headers="5" class="gt_row gt_right">39</td>
<td headers="7" class="gt_row gt_right">38</td>
<td headers="6" class="gt_row gt_right">37</td>
<td headers="8" class="gt_row gt_right">6</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<div id="design-stage-b" class="section level2">
<h2>2. Design stage (B)</h2>
<div id="hypothetical-scenario-1" class="section level3">
<h3>Hypothetical scenario 1</h3>
<p><em>No design; use all the information 0 and 1.</em></p>
<p>Complete randomized experiment. In the beginning, everyone was drinking,
but we implemented an intervention to make them stop drinking with a 1/2
probability. Then, we observed the use of marijuana in both groups.</p>
</div>
<div id="hypothetical-scenario-2" class="section level3">
<h3>Hypothetical scenario 2</h3>
<p><em>Trimming for the number of drugs.</em></p>
<p>Students who used more than three drugs were dropped from the analysis
because there were not enough participants in the control group with
that number of drugs used.</p>
</div>
<div id="hypothetical-scenario-3" class="section level3">
<h3>Hypothetical scenario 3</h3>
<p><em>Block or stratified randomized experiments.</em></p>
<p>Females and males were randomized into two different groups.</p>
</div>
<div id="hypothetical-scenario-4" class="section level3">
<h3>Hypothetical scenario 4</h3>
<p><em>Propensity score, IPW, and caliper.</em></p>
<p>A completely randomized experiment with balanced groups. The balance
between groups is achieved via inverse probability weighting (or
matching or a caliper).</p>
</div>
<div id="hypothetical-scenario-5" class="section level3">
<h3>Hypothetical scenario 5</h3>
<p><em>Randomized experiment controlling by base-line use of marijuana</em></p>
<p>Students who have not used marijuana are intervened to stop using
alcohol with a probability of 1/2. Then we compared marijuana initiation
in students who continued drinking alcohol to those who stopped.</p>
</div>
</div>
<div id="analysis" class="section level2">
<h2>3. Analysis</h2>
<p>Compare the outcomes of interest in the exposed versus non-exposed units
of the hypothetical randomized experiment.</p>
<p>We will estimate hypothetical scenario 1 and 4.</p>
<div id="hypothetical-scenario-1-1" class="section level3">
<h3>Hypothetical scenario 1</h3>
<p>No design. Use all units available.</p>
<pre class="r"><code>glm(marijuana ~ alcohol, 
    data=data_2019, 
    family = &quot;binomial&quot;) %&gt;% 
  tidy(exp=T, conf.int=T)</code></pre>
<pre><code>## # A tibble: 2 × 7
##   term        estimate std.error statistic p.value conf.low conf.high
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1 (Intercept)    0.146    0.0348     -55.2       0    0.136     0.156
## 2 alcoholYes    10.4      0.0416      56.3       0    9.61     11.3</code></pre>
</div>
<div id="hypothetical-scenario-4-1" class="section level3">
<h3>Hypothetical scenario 4</h3>
<p><strong>Inverse Probability Weighting (IPW)</strong></p>
<p>Estimates two different models:</p>
<ul>
<li><p>Model to compute propensity score.</p></li>
<li><p>Model to estimate the effect.</p></li>
</ul>
</div>
<div id="estimate-propensity-score" class="section level3">
<h3>Estimate propensity score</h3>
<p>What engine do we want to use?</p>
<pre class="r"><code>logistic &lt;- logistic_reg() %&gt;%
        set_engine(&quot;glm&quot;) %&gt;%
        set_mode(&quot;classification&quot;) </code></pre>
<p>What is the formula?</p>
<pre class="r"><code>formula_ps &lt;- recipe(alcohol ~ age + sex +q30 +
              q50 + q51 + q52 + q53 + q54+
              q55 + q56 + q57, data = data_2019)</code></pre>
<p>Combine the engine and formula in a workflow</p>
<pre class="r"><code>treatment_wflow &lt;-
  workflow() |&gt;  
  add_recipe(formula_ps) |&gt;
  add_model(logistic)</code></pre>
<p>Estimate the model</p>
<pre class="r"><code>fit(treatment_wflow, data=data_2019) |&gt; 
  tidy(conf.int=TRUE) </code></pre>
<pre><code>## # A tibble: 12 × 7
##    term        estimate std.error statistic   p.value conf.low conf.high
##    &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
##  1 (Intercept)   0.674     0.100     6.73   1.73e- 11    0.478     0.871
##  2 age           0.243     0.0145   16.7    7.79e- 63    0.215     0.271
##  3 sex           0.470     0.0351   13.4    7.97e- 41    0.401     0.539
##  4 q30          -1.84      0.0639  -28.8    5.11e-183   -1.97     -1.72 
##  5 q50           1.12      0.211     5.33   9.69e-  8    0.724     1.55 
##  6 q51           0.963     0.0954   10.1    6.27e- 24    0.778     1.15 
##  7 q52          -0.0321    0.348    -0.0921 9.27e-  1   -0.702     0.671
##  8 q53           0.244     0.319     0.766  4.44e-  1   -0.366     0.887
##  9 q54           1.17      0.235     4.99   6.10e-  7    0.729     1.65 
## 10 q55           0.754     0.258     2.92   3.45e-  3    0.263     1.28 
## 11 q56          -0.134     0.220    -0.610  5.42e-  1   -0.565     0.299
## 12 q57          -0.695     0.0404  -17.2    2.38e- 66   -0.774    -0.616</code></pre>
<p>Save the results of your model</p>
<pre class="r"><code>treatment_results &lt;- fit(treatment_wflow, data=data_2019) </code></pre>
<p>Plot the model results</p>
<pre class="r"><code>to_plot &lt;- fit(treatment_wflow, data=data_2019) |&gt; 
  tidy(conf.int=TRUE) 

ggplot(to_plot, aes(statistic, term)) +
  geom_point() +
  xlim(c(-19,19)) +
  geom_vline(xintercept = c(1.96,-1.96)) </code></pre>
<p><img src="/posts/2023-05-16-intro-to-causal/ipsw_files/figure-html/plot-results-psm-1.png" width="672" /></p>
<p>Next, estimate the propensity score</p>
<ul>
<li>Estimate the probability of receiving treatment given the covariates</li>
<li>Combine observed and estimated data (merge by ID)</li>
</ul>
<pre class="r"><code>to_ipw &lt;- predict(treatment_results, new_data = data_2019, type=&quot;prob&quot;)

to_ipw &lt;- bind_cols(to_ipw, data_2019) %&gt;% select(.pred_Yes, alcohol, everything())

head(to_ipw)</code></pre>
<pre><code>## # A tibble: 6 × 16
##   .pred_Yes alcohol .pred_No  year age         sex   q30   q50   q51   q52   q53
##       &lt;dbl&gt; &lt;fct&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl+lbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     0.896 &lt;NA&gt;       0.104  2019 1 [12 ye…     0     0     0     1     1     1
## 2     0.392 No         0.608  2019 3 [14 ye…     0     1     0     0     0     0
## 3     0.628 Yes        0.372  2019 3 [14 ye…     0     1     0     1     0     0
## 4     0.457 No         0.543  2019 3 [14 ye…     0     1     0     1     0     0
## 5     0.392 No         0.608  2019 3 [14 ye…     0     1     0     0     0     0
## 6     0.243 No         0.757  2019 3 [14 ye…     0     1     0     0     0     0
## # ℹ 5 more variables: q54 &lt;dbl&gt;, q55 &lt;dbl&gt;, q56 &lt;dbl&gt;, q57 &lt;dbl&gt;,
## #   marijuana &lt;fct&gt;</code></pre>
<p>Check for the area of common support</p>
<pre class="r"><code>to_ipw |&gt; 
  filter(!is.na(alcohol)) |&gt; 
  filter(!is.na(.pred_Yes)) |&gt; 
  group_by(alcohol) |&gt; 
  ggplot(aes(.pred_Yes, fill=alcohol)) +
  geom_density(adjust = 2, alpha=0.3) +
  theme_minimal()</code></pre>
<p><img src="/posts/2023-05-16-intro-to-causal/ipsw_files/figure-html/plot-propensities-1.png" width="672" /></p>
<p>Trim your data set</p>
<pre class="r"><code>to_ipw |&gt; filter(!is.na(alcohol)) |&gt; 
  filter(!is.na(.pred_Yes)) |&gt; 
  ggplot(aes(.pred_Yes, fill=alcohol)) + 
  geom_histogram(position = position_dodge(width = 0.1), binwidth = 0.09) +
  theme_minimal() </code></pre>
<p><img src="/posts/2023-05-16-intro-to-causal/ipsw_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<pre class="r"><code>to_ipw %&gt;% table1(~ .pred_Yes | alcohol, data=.)</code></pre>
<div class="Rtable1"><table class="Rtable1">
<thead>
<tr>
<th class='rowlabel firstrow lastrow'></th>
<th class='firstrow lastrow'><span class='stratlabel'>No<br><span class='stratn'>(N=7508)</span></span></th>
<th class='firstrow lastrow'><span class='stratlabel'>Yes<br><span class='stratn'>(N=8241)</span></span></th>
<th class='firstrow lastrow'><span class='stratlabel'>Overall<br><span class='stratn'>(N=16242)</span></span></th>
</tr>
</thead>
<tbody>
<tr>
<td class='rowlabel firstrow'>.pred_Yes</td>
<td class='firstrow'></td>
<td class='firstrow'></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>Mean (SD)</td>
<td>0.442 (0.141)</td>
<td>0.595 (0.208)</td>
<td>0.523 (0.196)</td>
</tr>
<tr>
<td class='rowlabel'>Median [Min, Max]</td>
<td>0.400 [0.165, 0.993]</td>
<td>0.568 [0.201, 0.999]</td>
<td>0.459 [0.165, 0.999]</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Missing</td>
<td class='lastrow'>18 (0.2%)</td>
<td class='lastrow'>68 (0.8%)</td>
<td class='lastrow'>107 (0.7%)</td>
</tr>
</tbody>
</table>
</div>
<pre class="r"><code>to_ipw &lt;- 
to_ipw %&gt;% 
  filter(.pred_Yes &gt; 0.25) %&gt;% 
  filter(.pred_Yes &lt; 0.75)

to_ipw %&gt;%  filter(!is.na(alcohol)) |&gt; 
  filter(!is.na(.pred_Yes)) |&gt; 
  ggplot(aes(.pred_Yes, fill=alcohol)) + 
  geom_histogram(position = position_dodge(width = 0.05), binwidth = 0.09) +
  theme_minimal() </code></pre>
<p><img src="/posts/2023-05-16-intro-to-causal/ipsw_files/figure-html/unnamed-chunk-1-2.png" width="672" /></p>
<p>Compute observation weights</p>
<pre class="r"><code>data_ipw &lt;-
  to_ipw |&gt;
  mutate(
    ipw = case_when(
      alcohol == &quot;Yes&quot; ~ 1 / .pred_Yes,
      alcohol == &quot;No&quot; ~ 1 / (1 - .pred_Yes)
    ),
    ipw = importance_weights(ipw)
  ) |&gt;
  select(ipw, alcohol, marijuana, everything())</code></pre>
</div>
<div id="check-for-balance-between-groups" class="section level3">
<h3>Check for balance between groups</h3>
<pre class="r"><code>ipw_test_recipe &lt;- recipe(alcohol ~ age + sex +
                            q30 + q50 + q51 + q52 + q53 + q54+
                            q55 + q56 + ipw, data = data_ipw)



ipw_test_wflow &lt;-
  workflow() |&gt;
  add_case_weights(ipw) |&gt;
  add_recipe(ipw_test_recipe) |&gt;
  add_model(logistic)

fit(ipw_test_wflow, data = data_ipw) |&gt;
  tidy()</code></pre>
<pre><code>## # A tibble: 11 × 5
##    term        estimate std.error statistic p.value
##    &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
##  1 (Intercept)  0.139      0.120    1.16     0.244 
##  2 age         -0.00765    0.0111  -0.691    0.489 
##  3 sex         -0.0232     0.0260  -0.891    0.373 
##  4 q30         -0.0879     0.115   -0.764    0.445 
##  5 q50          0.474      0.237    2.00     0.0458
##  6 q51          0.0631     0.0767   0.822    0.411 
##  7 q52          0.522      0.334    1.56     0.118 
##  8 q53         -0.00159    0.289   -0.00551  0.996 
##  9 q54          0.463      0.296    1.57     0.117 
## 10 q55          0.433      0.227    1.91     0.0563
## 11 q56         -0.0608     0.172   -0.354    0.724</code></pre>
<pre class="r"><code>to_plot_test_ipw &lt;- fit(ipw_test_wflow, data = data_ipw) |&gt;
  tidy()

ggplot(to_plot_test_ipw, aes(statistic, term)) +
  geom_point() +
  xlim(c(-19,19)) +
  geom_vline(xintercept = c(1.96,-1.96)) </code></pre>
<p><img src="/posts/2023-05-16-intro-to-causal/ipsw_files/figure-html/estimate-using-ipw-1.png" width="672" /></p>
</div>
<div id="fit-the-model-to-answer-the-question" class="section level3">
<h3>Fit the model to answer the question</h3>
<pre class="r"><code>finaldata &lt;- data_ipw |&gt; 
  select(marijuana, alcohol, ipw) 


causal_effect_recipe &lt;-
  recipe(marijuana ~ ., 
         data = finaldata)

causal_effect_wflow &lt;-
  workflow() |&gt;  
  add_case_weights(ipw) |&gt;
  add_recipe(causal_effect_recipe) |&gt;
  add_model(logistic)

fit(causal_effect_wflow, data = finaldata) |&gt; 
  tidy(exp=TRUE, conf.int=TRUE)</code></pre>
<pre><code>## # A tibble: 2 × 7
##   term        estimate std.error statistic p.value conf.low conf.high
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1 (Intercept)    0.144    0.0272     -71.2       0    0.137     0.152
## 2 alcoholYes     7.06     0.0326      59.9       0    6.63      7.53</code></pre>
<p>If you want, compare to a model with controls.</p>
<pre class="r"><code>glm(marijuana ~ alcohol + age + sex +q30 + q50 + q51 + q52 + 
         q53 + q54 + q55 + q56, data = data_ipw, family = binomial) %&gt;% 
  tidy(exp=T)</code></pre>
<pre><code>## # A tibble: 12 × 5
##    term        estimate std.error statistic  p.value
##    &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1 (Intercept)    0.145    0.196     -9.85  7.11e-23
##  2 alcoholYes     7.86     0.0471    43.7   0       
##  3 age            1.23     0.0194    10.8   4.94e-27
##  4 sex            1.08     0.0456     1.69  9.18e- 2
##  5 q30            0.302    0.185     -6.46  1.03e-10
##  6 q50            3.63     0.376      3.43  6.14e- 4
##  7 q51            1.32     0.123      2.28  2.29e- 2
##  8 q52            1.44     0.531      0.693 4.88e- 1
##  9 q53            2.20     0.520      1.51  1.30e- 1
## 10 q54            7.56     0.548      3.69  2.20e- 4
## 11 q55            0.684    0.372     -1.02  3.07e- 1
## 12 q56            1.72     0.285      1.90  5.71e- 2</code></pre>
<p>What is the difference between IPW and the controlled model?</p>
</div>
<div id="prevalence-of-marijuana-and-alcohol" class="section level3">
<h3>Prevalence of marijuana and alcohol</h3>
<pre class="r"><code>library(table1)
data_2019 %&gt;% 
  select(alcohol, marijuana) %&gt;% 
  table1(~alcohol | marijuana, data = .)</code></pre>
<div class="Rtable1"><table class="Rtable1">
<thead>
<tr>
<th class='rowlabel firstrow lastrow'></th>
<th class='firstrow lastrow'><span class='stratlabel'>No<br><span class='stratn'>(N=9943)</span></span></th>
<th class='firstrow lastrow'><span class='stratlabel'>Yes<br><span class='stratn'>(N=5936)</span></span></th>
<th class='firstrow lastrow'><span class='stratlabel'>Overall<br><span class='stratn'>(N=16242)</span></span></th>
</tr>
</thead>
<tbody>
<tr>
<td class='rowlabel firstrow'>alcohol</td>
<td class='firstrow'></td>
<td class='firstrow'></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>No</td>
<td>6471 (65.1%)</td>
<td>946 (15.9%)</td>
<td>7508 (46.2%)</td>
</tr>
<tr>
<td class='rowlabel'>Yes</td>
<td>3189 (32.1%)</td>
<td>4859 (81.9%)</td>
<td>8241 (50.7%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Missing</td>
<td class='lastrow'>283 (2.8%)</td>
<td class='lastrow'>131 (2.2%)</td>
<td class='lastrow'>493 (3.0%)</td>
</tr>
</tbody>
</table>
</div>
<pre class="r"><code>data_2019 %&gt;% 
  select(alcohol, marijuana) %&gt;% 
  table1(~marijuana | alcohol, data = .)</code></pre>
<div class="Rtable1"><table class="Rtable1">
<thead>
<tr>
<th class='rowlabel firstrow lastrow'></th>
<th class='firstrow lastrow'><span class='stratlabel'>No<br><span class='stratn'>(N=7508)</span></span></th>
<th class='firstrow lastrow'><span class='stratlabel'>Yes<br><span class='stratn'>(N=8241)</span></span></th>
<th class='firstrow lastrow'><span class='stratlabel'>Overall<br><span class='stratn'>(N=16242)</span></span></th>
</tr>
</thead>
<tbody>
<tr>
<td class='rowlabel firstrow'>marijuana</td>
<td class='firstrow'></td>
<td class='firstrow'></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>No</td>
<td>6471 (86.2%)</td>
<td>3189 (38.7%)</td>
<td>9943 (61.2%)</td>
</tr>
<tr>
<td class='rowlabel'>Yes</td>
<td>946 (12.6%)</td>
<td>4859 (59.0%)</td>
<td>5936 (36.5%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Missing</td>
<td class='lastrow'>91 (1.2%)</td>
<td class='lastrow'>193 (2.3%)</td>
<td class='lastrow'>363 (2.2%)</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="differences-in-differences" class="section level1">
<h1>2. Differences in differences 🔀</h1>
<ul>
<li>To evaluate the mean change after the implementation of an
intervention.</li>
<li>Estimate the counterfactual based on a comparison group.</li>
</ul>
<div class="figure">
<img src="did_imagen.png" alt="" />
<p class="caption"><a href="https://www.publichealth.columbia.edu/research/population-health-methods/difference-difference-estimation" class="uri">https://www.publichealth.columbia.edu/research/population-health-methods/difference-difference-estimation</a></p>
</div>
<div id="example-1" class="section level2">
<h2>Example</h2>
<p>Using the YRBS data, estimate the effect of marijuana legalization on
marijuana use in adolescents.</p>
<blockquote>
<p>What is the effect of marijuana legalization on the use of marijuana?</p>
</blockquote>
<p>Define a control group. Choose the best control group.</p>
<p>Timeline of marijuana policy reform in California</p>
<p>2016: Voters approved a ballot initiative legalizing marijuana for
adults and establishing a regulated marijuana market.</p>
<p>2017: Licensing and regulatory system for medical marijuana businesses
are paired with a similar regulatory system being developed for
non-medical, now under one agency.</p>
<p>2018: First legal sales for adult consumers began!</p>
<p>from: <a href="https://www.mpp.org/states/california/" class="uri">https://www.mpp.org/states/california/</a></p>
<p>The comparison group will be Florida.</p>
<p>from:
<a href="https://www.nytimes.com/interactive/2018/04/03/upshot/what-is-your-citys-twin.html" class="uri">https://www.nytimes.com/interactive/2018/04/03/upshot/what-is-your-citys-twin.html</a></p>
<pre class="r"><code>diff_diff &lt;- small_data %&gt;% 
  mutate(marijuana=factor(marijuana)) %&gt;%
  mutate(nmarijuana=case_when(marijuana==&quot;Yes&quot; ~ 1, 
                              marijuana==&quot;No&quot; ~ 0)) %&gt;% 
  select(state, year, marijuana, nmarijuana) %&gt;% 
  filter( state==&quot;FL&quot; |
         state==&quot;CA&quot;) %&gt;% 
  filter(year&gt;=2017)

head(diff_diff)</code></pre>
<pre><code>## # A tibble: 6 × 4
##   state  year marijuana nmarijuana
##   &lt;chr&gt; &lt;dbl&gt; &lt;fct&gt;          &lt;dbl&gt;
## 1 FL     2017 &lt;NA&gt;              NA
## 2 FL     2017 &lt;NA&gt;              NA
## 3 FL     2017 No                 0
## 4 FL     2017 No                 0
## 5 FL     2017 Yes                1
## 6 FL     2017 No                 0</code></pre>
<pre class="r"><code>diff_diff %&gt;% 
  ggplot(aes(x=year, y=nmarijuana, color=state, group=state)) +
  geom_smooth(method = &quot;glm&quot;, method.args = list(family = &quot;binomial&quot;), se=F) +
  coord_cartesian(ylim = c(0.3,0.42)) +
  theme_minimal() +
  labs(y=&quot;Marihuana Prevalence&quot;, x=&quot;Year&quot;, color=&quot;State&quot;) +
  scale_x_continuous(breaks = c(2017, 2019)) +
  scale_y_continuous(labels = scales::&quot;percent&quot;) +
  scale_color_manual(values=c(&quot;orange&quot;, &quot;skyblue&quot;))</code></pre>
<p><img src="/posts/2023-05-16-intro-to-causal/ipsw_files/figure-html/plot-your-data-1.png" width="672" /></p>
<div id="organize-the-data" class="section level3">
<h3>Organize the data</h3>
<pre class="r"><code>diff_diff2 &lt;-
  diff_diff %&gt;%
  filter(!is.na(marijuana)) %&gt;% 
  mutate(treatment = case_when(
    state == &quot;CA&quot; ~ 1,
    state != &quot;CA&quot; ~ 0
  )) %&gt;%
  mutate(year = year - 2017) %&gt;%
  mutate(interaction = treatment * year)

head(diff_diff2)</code></pre>
<pre><code>## # A tibble: 6 × 6
##   state  year marijuana nmarijuana treatment interaction
##   &lt;chr&gt; &lt;dbl&gt; &lt;fct&gt;          &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;
## 1 FL        0 No                 0         0           0
## 2 FL        0 No                 0         0           0
## 3 FL        0 Yes                1         0           0
## 4 FL        0 No                 0         0           0
## 5 FL        0 No                 0         0           0
## 6 FL        0 Yes                1         0           0</code></pre>
</div>
<div id="estimate-the-regression" class="section level3">
<h3>Estimate the regression</h3>
<p>Choose the engine</p>
<pre class="r"><code>logistic &lt;- logistic_reg() %&gt;%
        set_engine(&quot;glm&quot;) %&gt;%
        set_mode(&quot;classification&quot;) </code></pre>
</div>
<div id="the-formula" class="section level3">
<h3>The formula</h3>
<p><a href="https://jamboard.google.com/d/14Wrq0iFfAFk-CIIilw3dGRQWIJ54WHWsYzs9YeysoXk/edit?usp=sharing">Click here</a></p>
<pre class="r"><code>formula_did &lt;- recipe(marijuana ~ year + treatment + interaction, data = diff_diff2)</code></pre>
</div>
<div id="estimation" class="section level3">
<h3>Estimation</h3>
<pre class="r"><code>did_wflow &lt;-
  workflow() |&gt;  
  add_recipe(formula_did) |&gt;
  add_model(logistic)

fit(did_wflow, data=diff_diff2) |&gt; 
  tidy(conf.int=TRUE, exp=T) </code></pre>
<pre><code>## # A tibble: 4 × 7
##   term        estimate std.error statistic   p.value conf.low conf.high
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1 (Intercept)    0.502    0.0267   -25.8   1.02e-146    0.476     0.529
## 2 year           1.03     0.0183     1.81  7.03e-  2    0.997     1.07 
## 3 treatment      1.04     0.0652     0.615 5.39e-  1    0.916     1.18 
## 4 interaction    1.04     0.0468     0.767 4.43e-  1    0.946     1.14</code></pre>
<pre class="r"><code>did_results &lt;- fit(did_wflow, data=diff_diff2) </code></pre>
</div>
<div id="recover-the-prevalences-from-the-model" class="section level3">
<h3>Recover the prevalences from the model</h3>
<pre class="r"><code>to_predict &lt;- as.data.frame(tibble(year=c(0,0,2,2),
       treatment=c(1,0,1,0),
      interaction=c(0,0,1,1)))</code></pre>
<pre class="r"><code>predict(did_results, new_data = to_predict, type=&quot;prob&quot;)</code></pre>
<pre><code>## # A tibble: 4 × 2
##   .pred_No .pred_Yes
##      &lt;dbl&gt;     &lt;dbl&gt;
## 1    0.657     0.343
## 2    0.666     0.334
## 3    0.633     0.367
## 4    0.643     0.357</code></pre>
</div>
<div id="estimate-the-means-for-each-group" class="section level3">
<h3>Estimate the means for each group</h3>
<pre class="r"><code>diff_diff2 %&gt;% group_by(treatment, year) %&gt;% 
  summarise(mean=mean(nmarijuana, na.rm=T)) %&gt;% 
  ungroup() %&gt;% 
  pivot_wider(names_from=year, values_from=mean)</code></pre>
<pre><code>## # A tibble: 2 × 3
##   treatment   `0`   `2`
##       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1         0 0.334 0.349
## 2         1 0.343 0.375</code></pre>
</div>
</div>
</div>
<div id="the-end" class="section level1">
<h1>The end 🥳</h1>
</div>
<div id="reference" class="section level1">
<h1>Reference</h1>
<p>Bind, M.-A. C., &amp; Rubin, D. B. (2019). Bridging observational studies and randomized experiments by embedding the former in the latter. Statistical Methods in Medical Research, 28(7), 1958–1978. <a href="https://doi.org/10.1177/0962280217740609" class="uri">https://doi.org/10.1177/0962280217740609</a></p>
</div>
