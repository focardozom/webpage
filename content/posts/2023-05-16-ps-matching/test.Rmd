---
title: "Intro to causal inference"
output: html_document
date: "2023-05-10"
categories: ["Tidymodels"]
tags: ["Packages"]
---

# 1. Observational studies and propensity score âš–ï¸

-   Conceptual stage
-   Design stage
-   Statistical analysis
-   Summary

## Conceptual

Formulation of the causal question and assumptions using potential
outcomes. Formulated as a randomized experiment.

## Design stage

Reconstruct or approximate the design of a randomized experiment
(independence between treatment assignment and covariates). Needs to
conduct balance diagnostic.

## Statistical analysis

Compare outcomes by treatment. This stage is similar to the standard
model-based analysis.

## Summary

Conclusion based on your estimates.


```{r libraries, message=FALSE}

library(tidyverse) # data manipulation
library(skimr) # Good for descriptive analysis 
library(tidymodels) # modeling
library(gt)  # To create pretty tables
library(table1) # To create pretty tables
tidymodels_prefer() # to avoid problems with two functions with the same name
```

## 1. Conceptual stage

> What is the effect of alcohol consumption on marihuana use?

### Dataset

Selected data from YRBS

```{r load-data}
#load("Causal_inference/small_data.rda")
load("small_data.rda")

small_data  |> skimr::skim()

```

### Demographic variables

-   Age
-   Sex

### Outcome

-   Q46. How old were you when you tried marijuana for the first
    time? A. I have never tried marijuana B. 8 years old or younger C. 9
    or 10 years old D. 11 or 12 years old E. 13 or 14 years old F. 15 or
    16 years old G. 17 years old or older

-   marijuana: recoded as 0 (never used) 1 (used)

### Alcohol use ("Treatment")

-   Q40. How old were you when you had your first drink of alcohol other
    than a few sips? A. I have never had a drink of alcohol other than a
    few sips B. 8 years old or younger C. 9 or 10 years old D. 11 or 12
    years old E. 13 or 14 years old F. 15 or 16 years old G. 17 years
    old or older

-   alcohol: recoded as 0 (never used) 1 (used)

### Questions about drug use

-   Q30. Have you ever tried cigarette smoking, even one or two puffs?
-   Q50. During your life, how many times have you used any form of
    cocaine, including powder, crack, or freebase?
-   Q51. During your life, how many times have you sniffed glue,
    breathed the contents of aerosol spray cans, or inhaled any paints
    or sprays to get high?
-   Q52. During your life, how many times have you used heroin (also
    called smack, junk, or China White)?
-   Q53. During your life, how many times have you used methamphetamines
    (also called speed, crystal meth, crank, ice, or meth)?
-   Q54. During your life, how many times have you used ecstasy (also
    called MDMA)?
-   Q55. During your life, how many times have you taken steroid pills
    or shots without a doctor's prescription?
-   Q56. During your life, how many times have you used a needle to
    inject any illegal drug into your body?
-   Q57. During the past 12 months, has anyone offered, sold, or given
    you an illegal drug on school property?
    
    ### Filter by year

```{r filter-2019}

data_2019 <- small_data %>% 
  filter(year==2019) %>% 
  select(-district, -state)
  
```

## 2. Design stage (A)

### Balance diagnostic

```{r balance-age, warning=FALSE, message=FALSE}
data_2019 %>% 
  ggplot(aes(age, 
             fill=alcohol)) +
  geom_density(size=1, adjust=5, alpha=0.2) +
  theme_minimal()
```

```{r balance-sex, warning=FALSE, message=FALSE}
data_2019 %>% 
  filter(!is.na(alcohol)) %>% 
  mutate(sex=if_else(sex==1,1,0)) %>% 
  group_by(alcohol) %>% 
  summarise(`Females proportion`=
              mean(as.numeric(as.character(sex)), na.rm=T)) %>% 
  ggplot(aes(alcohol, `Females proportion`, fill=alcohol)) +
  geom_bar(stat="identity") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = c("purple", "gold"))
```

```{r balance-drug, warning=FALSE, message=FALSE}
data_2019 %>% 
  select(c("alcohol",  "q30", "q50", "q51","q52",
           "q53", "q54", "q55", "q56")) %>% 
  filter(!is.na(alcohol)) %>% 
  pivot_longer(cols=-alcohol, 
               names_to = "Drugs", 
               values_to="Use" ) %>% 
  group_by(alcohol, Drugs) %>% 
  summarise(prevalence=mean(Use, na.rm=T)) %>% 
  ggplot(aes(alcohol, prevalence)) +
  geom_bar(stat="identity") + 
  facet_wrap(~ Drugs, scales = "free") +
  theme_minimal()

```

```{r polyuse, warning=FALSE, message=FALSE}

data_2019 %>% 
  filter(!is.na(alcohol)) %>% 
  select(c("alcohol",  "q30", "q50", "q51","q52",
           "q53", "q54", "q55", "q56")) %>% 
  mutate(id=row_number()) %>% 
  pivot_longer(cols=-c(alcohol,id), 
               names_to = "Drugs", 
               values_to="Use" ) %>% 
  group_by(id, alcohol) %>% 
  summarise(sum=sum(as.numeric(Use), na.rm = T)) %>% 
  ungroup() %>% 
  count(alcohol, sum) %>% 
  pivot_wider(names_from = sum, values_from = n) %>% 
  gt() %>% 
  tab_header(
    title = "Number of substances")
  
```

## 2. Design stage (B)

### Hypothetical scenario 1

*No design; use all the information 0 and 1.*

Complete randomized experiment. In the beginning, everyone was drinking,
but we implemented an intervention to make them stop drinking with a 1/2
probability. Then, we observed the use of marijuana in both groups.

### Hypothetical scenario 2

*Trimming for the number of drugs.*

Students who used more than three drugs were dropped from the analysis
because there were not enough participants in the control group with
that number of drugs used.

### Hypothetical scenario 3

*Block or stratified randomized experiments.*

Females and males were randomized into two different groups.

### Hypothetical scenario 4

*Propensity score, IPW, and caliper.*

A completely randomized experiment with balanced groups. The balance
between groups is achieved via inverse probability weighting (or
matching or a caliper).

### Hypothetical scenario 5

*Randomized experiment controlling by base-line use of marijuana*

Students who have not used marijuana are intervened to stop using
alcohol with a probability of 1/2. Then we compared marijuana initiation
in students who continued drinking alcohol to those who stopped.

## 3. Analysis

Compare the outcomes of interest in the exposed versus non-exposed units
of the hypothetical randomized experiment.

We will estimate hypothetical scenario 1 and 4.

### Hypothetical scenario 1

No design. Use all units available.

```{r experiment1}

glm(marijuana ~ alcohol, 
    data=data_2019, 
    family = "binomial") %>% 
  tidy(exp=T, conf.int=T)
  
```

### Hypothetical scenario 4

**Inverse Probability Weighting (IPW)**

Estimates two different models:

-   Model to compute propensity score.

-   Model to estimate the effect.

### Estimate propensity score

What engine do we want to use?

```{r set-engine}

logistic <- logistic_reg() %>%
        set_engine("glm") %>%
        set_mode("classification") 

```

What is the formula?

```{r formula}

formula_ps <- recipe(alcohol ~ age + sex +q30 +
              q50 + q51 + q52 + q53 + q54+
              q55 + q56 + q57, data = data_2019)
```

Combine the engine and formula in a workflow

```{r workflow}

treatment_wflow <-
  workflow() |>  
  add_recipe(formula_ps) |>
  add_model(logistic)
```

Estimate the model

```{r estimate-model1}
fit(treatment_wflow, data=data_2019) |> 
  tidy(conf.int=TRUE) 

```

Save the results of your model

```{r save-model-results}
treatment_results <- fit(treatment_wflow, data=data_2019) 
```

Plot the model results

```{r plot-results-psm, warning=FALSE, message=FALSE}

to_plot <- fit(treatment_wflow, data=data_2019) |> 
  tidy(conf.int=TRUE) 

ggplot(to_plot, aes(statistic, term)) +
  geom_point() +
  xlim(c(-19,19)) +
  geom_vline(xintercept = c(1.96,-1.96)) 
```

Next, estimate the propensity score

-   Estimate the probability of receiving treatment given the covariates
-   Combine observed and estimated data (merge by ID)

```{r predic-prob}

to_ipw <- predict(treatment_results, new_data = data_2019, type="prob")

to_ipw <- bind_cols(to_ipw, data_2019) %>% select(.pred_Yes, alcohol, everything())

head(to_ipw)

```

Check for the area of common support

```{r plot-propensities}

to_ipw |> 
  filter(!is.na(alcohol)) |> 
  filter(!is.na(.pred_Yes)) |> 
  group_by(alcohol) |> 
  ggplot(aes(.pred_Yes, fill=alcohol)) +
  geom_density(adjust = 2, alpha=0.3) +
  theme_minimal()

```

Trim your data set

```{r}
to_ipw |> filter(!is.na(alcohol)) |> 
  filter(!is.na(.pred_Yes)) |> 
  ggplot(aes(.pred_Yes, fill=alcohol)) + 
  geom_histogram(position = position_dodge(width = 0.1), binwidth = 0.09) +
  theme_minimal() 

to_ipw %>% table1(~ .pred_Yes | alcohol, data=.)

to_ipw <- 
to_ipw %>% 
  filter(.pred_Yes > 0.25) %>% 
  filter(.pred_Yes < 0.75)

to_ipw %>%  filter(!is.na(alcohol)) |> 
  filter(!is.na(.pred_Yes)) |> 
  ggplot(aes(.pred_Yes, fill=alcohol)) + 
  geom_histogram(position = position_dodge(width = 0.05), binwidth = 0.09) +
  theme_minimal() 

```

Compute observation weights

```{r compute-ipw}

data_ipw <-
  to_ipw |>
  mutate(
    ipw = case_when(
      alcohol == "Yes" ~ 1 / .pred_Yes,
      alcohol == "No" ~ 1 / (1 - .pred_Yes)
    ),
    ipw = importance_weights(ipw)
  ) |>
  select(ipw, alcohol, marijuana, everything())


```

### Check for balance between groups

```{r estimate-using-ipw, warning=FALSE}

ipw_test_recipe <- recipe(alcohol ~ age + sex +
                            q30 + q50 + q51 + q52 + q53 + q54+
                            q55 + q56 + ipw, data = data_ipw)



ipw_test_wflow <-
  workflow() |>
  add_case_weights(ipw) |>
  add_recipe(ipw_test_recipe) |>
  add_model(logistic)

fit(ipw_test_wflow, data = data_ipw) |>
  tidy()

to_plot_test_ipw <- fit(ipw_test_wflow, data = data_ipw) |>
  tidy()

ggplot(to_plot_test_ipw, aes(statistic, term)) +
  geom_point() +
  xlim(c(-19,19)) +
  geom_vline(xintercept = c(1.96,-1.96)) 


```

### Fit the model to answer the question

```{r fit-ipw-model, warning=FALSE}

finaldata <- data_ipw |> 
  select(marijuana, alcohol, ipw) 


causal_effect_recipe <-
  recipe(marijuana ~ ., 
         data = finaldata)

causal_effect_wflow <-
  workflow() |>  
  add_case_weights(ipw) |>
  add_recipe(causal_effect_recipe) |>
  add_model(logistic)

fit(causal_effect_wflow, data = finaldata) |> 
  tidy(exp=TRUE, conf.int=TRUE)

```

If you want, compare to a model with controls.

```{r}
glm(marijuana ~ alcohol + age + sex +q30 + q50 + q51 + q52 + 
         q53 + q54 + q55 + q56, data = data_ipw, family = binomial) %>% 
  tidy(exp=T)

```

What is the difference between IPW and the controlled model?

### Prevalence of marijuana and alcohol

```{r prevalence-marijuana}
library(table1)
data_2019 %>% 
  select(alcohol, marijuana) %>% 
  table1(~alcohol | marijuana, data = .)

data_2019 %>% 
  select(alcohol, marijuana) %>% 
  table1(~marijuana | alcohol, data = .)
```

# The end ðŸ¥³

# Reference

Bind, M. , & Rubin, D. (2019). Bridging observational studies and randomized experiments by embedding the former in the latter. Statistical Methods in Medical Research, 28(7), 1958â€“1978. https://doi.org/10.1177/0962280217740609